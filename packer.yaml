---
variables:
  base_image_name: taskcluster-worker
  aws_region: us-west-2
  gcp_project_id: miles-packer-test
  gcp_zone: us-west1-a
  placeholder_secret: ""
  # set by make
  # comma separated strings become lists
  default_scripts: ""
  docker_worker_scripts: ""
  generic_worker_scripts: ""

builders:
  - name: docker_worker_aws
    type: amazon-ebs
    communicator: ssh
    # ssh_timeout: 15m
    ami_name: "{{user `base_image_name`}}-{{build_type}}-{{isotime | clean_resource_name}}"
    instance_type: c5.2xlarge
    # explicitly delete because of https://www.packer.io/docs/builders/amazon-ebs.html#delete_on_termination
    launch_block_device_mappings:
      - device_name: /dev/sda1
        volume_size: 40
        volume_type: gp2
        delete_on_termination: true
    source_ami_filter:
      filters:
        virtualization-type: hvm
        name: ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*
        root-device-type: ebs
      # canonical owner account
      owners:
        - 099720109477
      most_recent: true
    ssh_username: ubuntu
    region: "{{user `aws_region`}}"
    # FIXME uncomment when done iterating
    # ami_regions: "us-east-1,us-west-1"
  - name: docker_worker_gcp
    type: googlecompute
    image_name: "{{user `base_image_name`}}-{{build_type}}-{{isotime | clean_resource_name}}"
    source_image_family: ubuntu-1804-lts
    ssh_username: ubuntu
    project_id: "{{user `gcp_project_id`}}"
    zone: "{{user `gcp_zone`}}"
  - type: vagrant
    box_name: "{{user `base_image_name`}}-{{build_type}}"
    add_force: true
    communicator: ssh
    source_path: ubuntu/bionic64
    provider: virtualbox

provisioners:
  # created by make tar
  - type: file
    source: ./files.tar
    destination: /tmp/
  # untar at /
  - type: shell
    # files.tar is two levels deep (/tmp/files)
    inline:
      - sudo tar xvf /tmp/files.tar -C / --strip-components=2
      - rm /tmp/files.tar
  # created by pack_secrets.py, make tar
  - type: file
    source: ./secrets.tar
    destination: /tmp/
  # untar at /
  - type: shell
    inline:
      - sudo tar xvf /tmp/secrets.tar -C /
      - sudo chown root:root -R /etc/taskcluster
      - sudo chmod 0400 -R /etc/taskcluster/secrets
      # FIXME
      # actually delete, just for testing
      # - rm /tmp/secrets.tar
  - type: shell
    inline:
      - /usr/bin/cloud-init status --wait
  # post cloud-init
  # run all scripts as root
  - type: shell
    scripts: "{{ user `default_scripts` }}"
    execute_command: sudo -S sh -c '{{ .Vars }} {{ .Path }}'
    # we reboot the host to update the kernel
    expect_disconnect: true
  - type: shell
    scripts: "{{ user `docker_worker_scripts` }}"
    execute_command: sudo -S sh -c '{{ .Vars }} {{ .Path }}'
    only:
      - docker_worker_aws
      - docker_worker_gcp
  # FIXME
  # no builds for this yet
  - type: shell
    scripts: "{{ user `generic_worker_scripts` }}"
    execute_command: sudo -S sh -c '{{ .Vars }} {{ .Path }}'
    only: []

post-processors:
  - type: manifest
    output: packer-artifacts.json
    strip_path: true
